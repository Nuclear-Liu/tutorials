# 性能监控


> MySQL 三个组成部分， `Client` `MySQL Server` `Storage Engine`
> 
> `MySQL Server` 的连接器负责 `Client` 连接认证；
> `MySQL Server` 的分析器负责词法分析、语法分析，将 SQL 最终转换成**抽象语法树(AST)**；
> `MySQL Server` 的优化器（两种方式：1. **RBO** （基于规则的优化） 2. **CBO** （基于成本、代价的优化，更多的是这种方式））对查询进行优化；
> `MySQL Server` 的执行器用来与存储引擎交互获取数据；
> `MySQL Server` 的查询缓存（MySQL 8.0 之前的版本有，8.0之后废弃；）；
> 
> 
> 存储引擎 (Storage Engine) :
> 
> * `InnoDB` 基于磁盘
>
> * `MyISAM` 基于磁盘
> 
> * `memory` 基于内存


## 使用 `show profile` 查询刨析工具


[MySQL Document](https://dev.mysql.com/doc/) : `SQL Statements` `Database Administration Statements` `SHOW Statements` `SHOW PROFILE Statement`


`show profile` `show profiles` 显示分析当前会话过程中执行的语句的资源使用情况。


```sql
SHOW PROFILE [type [, type] ... ] [FOR QUERY n] [LIMIT row_count [OFFSET offset]];
```

```sql
type: {
    ALL                 -- 显示所有性能信息
  | BLOCK IO            -- 显示块 IO 操作次数
  | CONTEXT SWITCHES    -- 显示主动、被动上下文切换次数
  | CPU                 -- 显示 `CPU_user` `CPU_system` 时间
  | IPC                 -- 显示发送和接收消息的计数
  | MEMORY              -- 暂未实现
  | PAGE FAULTS         -- 目前主要和次要页错误计数
  | SOURCE              -- 显示源码中的函数名称与位置
  | SWAPS               -- 显示交换计数
}
```


> `SHOW PROFILE` `SHOW PROFILES` 语句已弃用 ；期望它们在未来的 MySQL 版本中被删除。
> 改用 `Performance Schema` ；


1. 查询是否开启 `profile` 设置 `SELECT @@profiling;` 

  * `0` : 关闭；

  * `1` : 开启；

2. 设置开启 `set profiling = 1;` ；
3. 执行 SQL 语句；
4. 执行 `show profiles;` ；

  获取查询所有SQL的具体执行时间；

| Query_ID | Duration | Query |
|----------|----------|-------|
| ` `      | ` `      | ` `   |

4. 执行 `SHOW PROFILE [type [, type] ... ] [FOR QUERY n] [LIMIT row_count [OFFSET offset]];` ；

  获取一次查询每个阶段的时间花销；
  
  默认最后一次，通过添加 `for query query_id` 查看具体 `Query_ID` 的具体时间花销；

| Status               | Duration |
|----------------------|----------|
| starting             | ` `      |
| checking permissions | ` `      |
| Opening tables       | ` `      |
| init                 | ` `      |
| System lock          | ` `      |
| optimizing           | ` `      |
| statistics           | ` `      |
| preparing            | ` `      |
| executing            | ` `      |
| Sending data         | ` `      |
| end                  | ` `      |
| query end            | ` `      |
| closing tables       | ` `      |
| freeing items        | ` `      |
| cleaning up          | ` `      |
 

## 使用 `Performance Schema` 监控 MySQL


1. `performance_schema` 数据库（不可以创建表）使用 `performance_schema` 存储引擎。
  该数据库主要关注数据库运行过程中的性能相关的数据，

2. `performance_schema` 通过监控 server 的**事件**来实现监控 server 内部运行情况；

  事件是 server 内部互动中所做的任何事情以及对应时间消耗。

3. `performance_schema`
