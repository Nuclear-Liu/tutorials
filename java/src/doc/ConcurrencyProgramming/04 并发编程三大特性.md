# 并发编程三大特性

## 可见性(`visibility`)

默认情况下一个线程改变一个变量值，另一个线程看不到最新的值；
可见性是线程之间的缓存（不是 Thread Local ）互相之间保持数据一致性（线程缓存与内存中数据保持同步）的一种机制；

* 通过关键字 `volatile` 关键字修饰变量可以使的变量线程间可见；

    `volatile` 修饰引用类型（包括数组）只能保证引用本身的可见性，不能保证内部字段的可见性；
    `volatile` 还可以禁止指令重排序；

* 线程之间一些**语句**会触发内存缓存同步刷新（存在同步 `synchronized` 等关键字）；


> 每个线程运行时，会把变量拷贝一份放在线程自己的缓存；每次读取数据读取的时线程的缓存，不会在重新读；


| CPU 计算单元 ALU 访问： | 速度       |
|------------------|----------|
| Registers        | `1< ns`  |
| L1 cache         | 约 `1ns`  |
| L2 cache         | 约 `3ns`  |
| L3 cache         | 约 `15ns` |
| main memory      | 约 `80ns` |


> **缓存行（Cache Line(64 Byte)）**
> 
> 为了缓存效率更高，根据程序的局部性原理（空间局部性），缓存是按照相邻区域的内存进行缓存（缓存行）；
> 
> 时间局部性原理是指令的缓存，空间局部性原理是数据的缓存；
> 
> 缓存行越大，局部性空间效率越高，读取时间慢；
> 缓存行越小，局部性空间效率越低，读取时间快；
> 通过普遍的工业实践，目前缓存行大小为 `64 Byte` ；

> **缓存一致性**
> 
> MESI Cache 一致性协议是缓存一致性协议的一种（MOSI等）；
> MESI 将缓存行 (Cache Line) 标记为四种状态： `Modified` `Exclusive` `Shared` `Invalid` ；主动进行数据更新；
> 
> `volatile` 低层与 `MESI` 无关；
> 
> 如果变量位于同一行，需要缓存一致性协议保持行内数据的一致，导致效率下降；
> 
> `@Contended` : 保证数据与其他数据不会唯一同一缓存行（仅在 1.8 版本 JDK 可用）； 
> 注解生效需要修改 JVM 运行参数： `-XX:-RestrictContended` 注解才可以生效；

## 有序性(`ordering`)

## 原子性(`atomicity`)

