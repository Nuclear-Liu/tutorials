# java memory model

## 硬件层的并发优化

### 总线锁

旧的 CPU 支持 **总线锁** (bus lock) 锁住内存总线，保证一致性；
使的其他 CPU 甚至不能访问内存中的其他的地址，因而效率低

### 缓存锁

缓存锁，通过**一致性协议**实现，保证 CPU 间缓存行的一致性；
一致性协议包括： `MSI` `MESI` `Synapse` `Firefly` `Dragon` 等；

一般以 MESI （Intel CPU）介绍；
CPU 为每个 cache line 标记四种状态（额外两位）：
`Modified`(修改) 、 `Exclusive`(独享) 、 `Shared`(共享) 、 `Invalid`(无效；当前CPU读取到的值已经被其他CPU修改) ：

对于**无法被缓存**的数据或者跨越**多个缓存行**的数据依然必须使用**总线锁**；

> 现代 CPU 的数据一致性硬件实现： **缓存锁** + **总线锁**；

> 缓存行 cache line
> 
> 主存与缓存行交换数据的最小单位，目前一般为 `64 Byte` ；

> **伪共享**
> 
> 位于同一个缓存行的两个数据，被不同的 CPU 锁定，产生互相影响的伪共享问题；
> 使用**缓存行的对齐**解决伪共享问题；
