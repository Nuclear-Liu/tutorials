# 进程间通信

进程间通信(IPC) 是在 Electron 中构建功能丰富的桌面应用程序的关键之一。
IPC 是执行许多常见任务（例如：调用原生 API 或从原生菜单触发页面内容更改）的唯一方法。

**IPC 通道** 在 Electron 中进程使用 `ipcMain` `ipcRenderer` 模块，通过开发人员定义的**通道**传递消息进行通信。
**通道**是**任意**（随意命名）和**双向**（在模块间使用相同的通信名称）。

> **IPC 通道名称**
> 
> IPC 通道名称可以使用 **`:`** 分割不同的命名空间，帮助提高代码可读性。

## 模式 1: 渲染器进程到主进程(*单向*)

**单向** IPC 消息从渲染器进程到主进程：
* 使用 `ipcMain.on` API 监听接收消息
* 使用 `ipcRenderer.send` API 发送消息


1. 在主进程中 `main.js` 使用 `ipcMain.on` 监听事件

    `ipcMain.on(channel: string, listener: (event: IpcMainEvent, ...args: any[]) => void)`
    参数 `listener` 回调函数有两个参数： `IpcMainEvent` `any[]` 
    
    `IpcMainEvent` 包含消息发送发信息(`event.sender`)

2. 在预加载脚本暴露 `ipcRender.send`

    通过 `contextBridge` 使用 `ipcRender.send` 暴露主进程中的 `ipcMain.on` 监听事件

3. 渲染器进程调用

## 模式 2: 渲染器进程到主进程(*双向*)

**双向** IPC 从**渲染进程**调用**主进程**模块并等待结果：
* 使用 `ipcMain.handle` API 监听调用
* 使用 `ipcRender.invoke` API 调用并携带返回值


1. 在主进程中 `main.js` 使用 `ipcMain.handler` 监听事件

    `handle(channel: string, listener: (event: IpcMainInvokeEvent, ...args: any[]) => (Promise<void>) | (any))`

    如果在页面窗口是建议放在 `app.whenReady` 后定义，如果在窗口函数内会报错重复定义。

2. 在预加载脚本暴露 `ipcRender.invoke`
3. 渲染器进程调用

## 模式 3: 主进程到渲染器进程

**主进程**到**渲染器进程**通过 `WebContents` 实例的 `send` 将消息发送到指定渲染器。
* 使用主线程中窗口对象的 `WebContents` 实例的 `send` 方法发送消息
* 使用 `ipcRender.on`

> `WebContents` 实例的 `send` 与 `ipcRenderer.send` 用法相似。


1. 在主进程中 `main.js` 使用 `BrowserWindow` 实例的 `webContents` 模块的 `send` 发送消息

   `send(channel: string, ...args: any[])`

2. 在预处理脚本通过 `contextBridge` 和 `ipcRenderer.on` 暴露 IPC 功能
   
   `on(channel: string, listener: (event: IpcRendererEvent, ...args: any[]) => void)`
   
3. 渲染器进程通过 `window.<apiKey>` 或直接使用 `<apiKey>` 对暴露的 IPC 设置创建的接口

> **返回主线程一个回复**
> 
> 渲染器进程创建 IPC 接口时，可以在回调中通过 `event` (`IpcRendererEvent` 类型) 的 `send` 方法，发送回复给主线程。

## 模式 4: 渲染器进程到渲染器进程

在 Electron 中渲染器进程间不能直接传递消息。

实现：
1. **主进程**作为渲染器进程间的消息代理
   
   消息从一个渲染器进程发送到主进程，然后主进程将消息转发到另一个渲染器进程。
   
2. **主进程**将一个 `MessagePort` 传递到两个渲染器（在初始设置后，渲染器之间直接进行通信）

## 对象序列化

Electron 的 IPC 实现使用 HTML 标准的**结构化克隆算法**来序列化进程之间传递的对象（即**仅有某些对象可以通过IPC通道传递**）。
